# 手眼标定详细教程 - 零基础版

## 📚 什么是手眼标定？

**简单理解**：
- 相机看到的物体位置是**相机坐标系**下的 (x_cam, y_cam, z_cam)
- 机器人需要的是**机器人基座坐标系**下的 (x_base, y_base, z_base)
- 手眼标定就是找到这两个坐标系之间的**转换关系**

**打个比方**：
就像你在地图上看到一个地点，需要把地图坐标转换成GPS坐标，才能导航过去。

---

## 🎯 标定的目标

获得一个 **4x4 的变换矩阵** `T_cam2base`，用它可以把相机坐标转换成机器人坐标：

```
点_机器人 = T_cam2base × 点_相机
```

---

## 📋 准备工作 (开始前必须完成)

### 1. 准备 AprilTag 标定板

**什么是 AprilTag？**
- 一种黑白方块标记，类似二维码
- 相机可以精确识别它的位置和姿态

**获取方法**：

#### 方法A：打印 (推荐，快速)
1. 下载标签图片：
   ```bash
   cd /home/psibot/Documents/psibot_control
   wget https://github.com/AprilRobotics/apriltag-imgs/raw/master/tag25h9/tag25_09_00000.png
   ```

2. 打印要求：
   - **纸张大小**：A4 白纸
   - **打印尺寸**：标签**黑色方块外边缘**调整到 **75mm × 75mm**
   - **打印设置**：100% 缩放，无边距
   - **纸张质量**：普通打印纸即可，但要平整

3. 打印后处理：
   - 用尺子量一下，确认黑色外边缘是 75mm
   - 贴在硬纸板或亚克力板上，保持平整
   - 避免褶皱和反光

#### 方法B：购买 (更耐用)
- 淘宝搜索 "AprilTag 标定板 75mm"
- 选择 tag25h9 系列
- 价格约 20-50 元

**⚠️ 重要**：标签尺寸必须是 **75mm**，这是程序中设定的！

### 2. 准备标定环境

- **桌面**：清理干净，只放 AprilTag 标定板
- **光照**：充足且均匀，避免强烈阴影
- **位置**：将 AprilTag 放在机器人工作空间内，相机能看到的地方
- **固定**：用双面胶或胶带把标定板固定在桌面上，防止移动

### 3. 检查硬件连接

```bash
# 检查相机是否连接
python list_cameras.py
# 应该能看到你的相机序列号

# 检查机器人是否连接
# (尝试运行简单的测试程序)
python test_arm_simple.py
```

---

## 🔧 步骤 1: 配置标定程序

让我帮你更新标定程序的配置：

### 1.1 确认你的硬件参数

**需要知道的信息**：
1. 相机序列号 (从 `list_cameras.py` 获取)
2. 机器人IP地址 (通常是 192.168.100.100 或 192.168.100.101)
3. AprilTag 实际尺寸 (默认 75mm = 0.075m)

### 1.2 运行配置脚本

我会为你创建一个自动配置脚本。

---

## 🎬 步骤 2: 运行标定程序

### 2.1 启动程序

```bash
cd /home/psibot/Documents/psibot_control
python camera_calibreate.py
```

### 2.2 程序界面说明

程序启动后会看到：

```
=== 标定数据采集 ===
1. 将机器人移动到不同位置
2. 确保AprilTag标签在相机视野内
3. 按 'c' 键保存当前数据
4. 按 'q' 键退出采集过程
目标: 收集 20 个不同位姿
```

**窗口显示内容**：
- 实时相机画面
- 检测到的 AprilTag (绿色框和角点)
- 机器人当前位置 (XYZ 和 RPY)
- 已采集的数量 (0/20)

### 2.3 操作详解

#### 第一次采样：
1. **手动移动机器人**（使用示教器或键盘控制）到一个位置
2. 观察屏幕，确保：
   - ✅ AprilTag **完整**出现在画面中
   - ✅ 绿色框准确框住了标签的4个角
   - ✅ 画面中显示了 X/Y/Z 坐标轴（红绿蓝三条线）
3. 如果一切正常，**按 'c' 键**
4. 看到提示 "✓ 成功保存位姿 1/20"

#### 后续采样（重复 19 次）：

**关键原则**：每次移动后的**位置和角度要明显不同**！

**推荐的采样策略**（按顺序来）：

**1-5 次：不同高度**
- 机器人离标签 **远一点**（约 40-50cm）
- 机器人离标签 **中等**（约 30cm）
- 机器人离标签 **近一点**（约 20cm，但不要太近看不到标签边缘）
- 每个高度采样 1-2 次

**6-10 次：不同角度（俯视角）**
- 垂直向下看（90度）
- 斜着看，从左上方（约 60度）
- 斜着看，从右上方（约 60度）
- 斜着看，从正前方（约 45度）
- 斜着看，从正后方（约 45度）

**11-15 次：不同水平位置**
- 移到标签**左侧**上方
- 移到标签**右侧**上方
- 移到标签**前方**上方
- 移到标签**后方**上方
- 移到标签**中心**上方

**16-20 次：混合位置**
- 随机组合前面的高度和角度
- 尽量覆盖你实际使用时机器人可能出现的位置

**⚠️ 重要提示**：
- 如果按 'c' 后提示 "位姿与前一个过于相似"，说明移动不够大，需要换个差异更大的位置
- 如果提示 "未检测到有效的AprilTag"，说明标签不在视野内或识别不清
- 不要着急，慢慢来，质量比速度重要！

### 2.4 采集过程中的常见问题

**问题1：检测不到 AprilTag**
- ✅ 检查光照是否充足
- ✅ 标签是否平整无褶皱
- ✅ 标签是否在相机视野中心区域
- ✅ 距离是否合适（20-50cm）

**问题2：检测不稳定（绿框一闪一闪）**
- ✅ 改善光照
- ✅ 标签太小或太远，靠近一点
- ✅ 运动模糊，等机器人停稳后再采样

**问题3：坐标轴显示不对**
- ✅ 标签可能贴反了，检查方向
- ✅ 距离太近或太远

### 2.5 完成采集

采集到 20 个位姿后：
- 程序会自动开始计算标定结果
- 显示不同算法的结果（TSAI, PARK, DANIILIDIS 等）
- 自动选择 PARK 方法（通常效果最好）
- 保存结果到 `calibration_results/` 文件夹

---

## ✅ 步骤 3: 验证标定结果

标定完成后，**必须验证质量**！

### 3.1 查看标定文件

```bash
ls -lh calibration_results/
# 应该看到：
# camera_calibration_YYYYMMDD-HHMMSS.npz  (变换矩阵)
# camera_info_YYYYMMDD-HHMMSS.json        (元数据)
```

### 3.2 运行验证程序

```bash
python vis_cam_to_base.py
```

**期望看到**：
- 窗口显示实时相机画面
- 机器人末端位置上叠加了**红绿蓝三色坐标轴**
- 移动机器人时，坐标轴**跟随末端移动**

**判断标定质量**：

✅ **好的标定**：
- 坐标轴准确投影在机器人末端上
- 移动机器人时，坐标轴位置准确跟随
- 偏差小于 1-2 cm

❌ **差的标定**：
- 坐标轴位置明显偏离末端
- 偏差大于 5 cm
- 移动时坐标轴漂移很大

**如果标定质量差，需要重新标定！**

---

## 📊 步骤 4: 理解标定结果

标定完成后，程序会输出：

```
===== 相机到机器人基座的变换 (cam2base) =====
4x4变换矩阵:
[[ 0.123  -0.456   0.789  0.250]
 [-0.987   0.654  -0.321  0.150]
 [ 0.456   0.789   0.654  0.500]
 [ 0.000   0.000   0.000  1.000]]

欧拉角 (度):
Roll (X): 45.23°, Pitch (Y): -12.34°, Yaw (Z): 78.90°

平移向量 (米): X: 0.2500, Y: 0.1500, Z: 0.5000
```

**含义**：
- **前3×3矩阵**：旋转关系（相机坐标系相对基座旋转了多少度）
- **最后一列前3个**：平移关系（相机在基座坐标系中的位置 XYZ）
- **欧拉角**：旋转用角度表示，更直观
- **平移向量**：相机距离机器人基座原点的距离

**合理性检查**：
- 平移向量的数值应该与你的实际硬件布局接近
- 例如相机在机器人上方 50cm，Z 应该接近 0.5

---

## 🔄 如果需要重新标定

### 情况1：验证结果不好
```bash
# 直接重新运行
python camera_calibreate.py
```

### 情况2：想保留之前的结果
```bash
# 备份旧结果
mv calibration_results calibration_results_backup_$(date +%Y%m%d_%H%M%S)

# 创建新文件夹
mkdir calibration_results

# 重新标定
python camera_calibreate.py
```

---

## 💡 标定技巧和建议

### 1. 采样位姿的质量很重要
- ❌ 不要：20个位姿都在同一个角度，只是距离不同
- ✅ 要：覆盖各种角度、距离、位置

### 2. 检测质量要高
- 确保每次按 'c' 时，绿色框都**稳定**地框住标签
- 如果画面模糊或抖动，等稳定后再保存

### 3. 标签摆放
- 放在工作空间的**中心区域**
- 确保从多个角度都能看到
- 保持平整，不要有阴影

### 4. 如何判断采样是否充分
好的采样应该：
- 高度变化范围：20cm - 50cm
- 角度变化范围：30° - 90° (相对垂直)
- 水平位置：覆盖标签上方的圆形区域

---

## 🐛 常见错误排查

### 错误1: "找不到相机"
```
解决方法：
1. 检查相机USB连接
2. 运行 python list_cameras.py 查看序列号
3. 更新程序中的相机序列号
```

### 错误2: "无法连接机器人"
```
解决方法：
1. ping 192.168.100.100 检查网络
2. 确认机器人已开机
3. 检查IP地址是否正确
```

### 错误3: "收集的标定数据不足"
```
解决方法：
至少需要3组有效数据，但建议15-20组
检查是否太多位姿被判定为"过于相似"
```

### 错误4: 标定结果平移向量异常
```
例如：X: 10.5, Y: -8.3, Z: 15.2 (单位米)
这明显不合理！

解决方法：
1. 检查AprilTag尺寸设置 (应该是0.075)
2. 重新打印标签，确保尺寸准确
3. 重新标定
```

---

## ✨ 标定完成后

恭喜！你已经完成了最关键的一步！

**下一步**：
1. ✅ 验证标定结果 (vis_cam_to_base.py)
2. ➡️ 进行点云获取测试 (get_pc.py)
3. ➡️ 测试VLM集成

**保存好标定文件**：
```bash
# 标定文件很重要，建议备份！
cp -r calibration_results calibration_results_backup
```

---

## 📞 需要帮助？

如果遇到问题：
1. 查看上面的"常见错误排查"
2. 检查 `calibration_images/` 中保存的图片，看检测是否准确
3. 可以把错误信息发给我

---

**现在，准备好了就开始吧！ 🚀**

记住：
- 不要着急，慢慢来
- 质量比速度重要
- 多采样几次总是好的

